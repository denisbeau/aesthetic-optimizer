name: iOS Build & Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-test:
    name: Build & Test iOS App
    runs-on: macos-14

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Inject GoogleService-Info.plist (for Firebase/Remote Config)
      env:
        GOOGLESERVICE_INFO_PLIST_B64: ${{ secrets.GOOGLESERVICE_INFO_PLIST_B64 }}
      run: |
        mkdir -p "LooksmaxxingApp/Resources"
        if [ -z "${GOOGLESERVICE_INFO_PLIST_B64}" ]; then
          echo "⚠️ GOOGLESERVICE_INFO_PLIST_B64 secret not set. Creating placeholder GoogleService-Info.plist for CI."
          cat > "LooksmaxxingApp/Resources/GoogleService-Info.plist" <<'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0"><dict></dict></plist>
        EOF
        else
          python3 - <<'PY'
        import os, base64, pathlib, binascii

        raw = os.environ["GOOGLESERVICE_INFO_PLIST_B64"]
        out = pathlib.Path("LooksmaxxingApp/Resources/GoogleService-Info.plist")

        # We accept either:
        # 1) base64-encoded plist bytes, OR
        # 2) raw XML plist text (common if someone pasted the file contents into the secret)
        try:
            decoded = base64.b64decode(raw, validate=True)
            out.write_bytes(decoded)
            print(f"✅ Wrote {out} from base64 ({out.stat().st_size} bytes)")
        except binascii.Error:
            out.write_text(raw, encoding="utf-8")
            print(f"✅ Wrote {out} from raw text ({out.stat().st_size} bytes)")
        PY
        fi

    - name: Select Xcode 15
      run: sudo xcode-select -s /Applications/Xcode_15.2.app

    - name: Show build environment
      run: |
        xcodebuild -version
        swift --version
        echo "Available simulators:"
        xcrun simctl list devices available | head -30

    - name: Build app
      run: |
        xcodebuild build \
          -project LooksmaxxingApp.xcodeproj \
          -scheme LooksmaxxingApp \
          -sdk iphonesimulator \
          -configuration Debug \
          -derivedDataPath build \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          ONLY_ACTIVE_ARCH=NO

    - name: Run unit tests
      run: |
        xcodebuild test \
          -project LooksmaxxingApp.xcodeproj \
          -scheme LooksmaxxingApp \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.2' \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          | tee test_output.txt || true
        
        # Check if tests passed
        if grep -q "TEST SUCCEEDED" test_output.txt; then
          echo "✅ All tests passed!"
        else
          echo "❌ Some tests failed"
          exit 1
        fi

    - name: Package app for Appetize.io
      if: always()
      run: |
        if [ -d "build/Build/Products/Debug-iphonesimulator/LooksmaxxingApp.app" ]; then
          cd build/Build/Products/Debug-iphonesimulator
          zip -r $GITHUB_WORKSPACE/LooksmaxxingApp-Simulator.zip LooksmaxxingApp.app
          echo "✅ App packaged for Appetize.io"
        else
          echo "⚠️ App not built, skipping packaging"
        fi

    - name: Upload app artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: LooksmaxxingApp-Simulator
        path: LooksmaxxingApp-Simulator.zip
        retention-days: 30
        if-no-files-found: ignore

    - name: Upload test results on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-failure-logs
        path: test_output.txt
